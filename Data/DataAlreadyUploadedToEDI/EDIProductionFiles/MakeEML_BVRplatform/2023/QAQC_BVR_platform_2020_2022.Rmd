---
title: "BVR Plots for EDI"
output: html_document
date: "2023-03-10"
---
 This script takes the raw outputs from the water quality sensors at Beaverdam combines them into one file, identifies gaps in the data, runs the data through the QAQC function (qaqc_bvr), and produces QAQC plots for visual inspection. 
 
 1. Open the script and check you have the correct function in line 19
 2. Change the current start and end times to match the year you are publishing for
 3. If there are more than one csv make sure they are all in the Download data chunk. Currently there is only one csv with all of the observations. 
 4. Once you have made sure everything is up to date press the knit button and it will produce an html file with all of the outputs and plots. 
 
 Use this file path in Carey Lab Reservoir GitHub Repo:
"./Data/DataAlreadyUploadedToEDI/EDIProductionFiles/MakeEML_BVRplatform/2023/"
 

```{r Set Up, include=FALSE}
pacman::p_load("RCurl","tidyverse","lubridate", "plotly", "magrittr","scattermore", "knitr")

source("BVR_platform_function_2020_2023.R")


# Set up the current time end time of the file and the current year for QAQC plots

#current time of QAQC for graphing
current_time_start="2023-01-01 00:00:00, tz=UTC"
current_time_end="2023-12-31 23:59:00, tz=UTC"
```

```{r Create Data folder, include=FALSE}
### Create a misc_data_files folder if one doesn't already exist
misc_folder <- "misc_data_files"
if (file.exists(misc_folder)) {
  cat("The folder already exists")
} else {
  dir.create(misc_folder)
}
```

```{r Download data, eval=FALSE, include=FALSE}
# This section downloads the data from Github and the maintenance file. 
# If there are changes to the data on Github then you have to redownload the files

# Set the timeout option to 100 seconds instead of 60
options(timeout=200)

# This function to speeds up the download time of the data downloads. 
# If your wifi is slow then it will still take a while. 

bdown=function(url, file){
  library('RCurl')
  f = CFILE(file, mode="wb")
  a = curlPerform(url = url, writedata = f@ref, noprogress=FALSE)
  close(f)
  return(a)
}
# download most up to date catwalk data, manual downloads and maintenance log
# goal in 2023 is to have the missing files on the data logger-no time now and need to talk to CCC
bdown('https://raw.githubusercontent.com/FLARE-forecast/BVRE-data/bvre-platform-data/bvre-waterquality.csv', "misc_data_files/bvre-waterquality.csv") 
bdown('https://raw.githubusercontent.com/CareyLabVT/ManualDownloadsSCCData/master/BVRPlatform/BVR_manual_2022.csv', "misc_data_files/BVRmanualplatform.csv")
bdown("https://raw.githubusercontent.com/FLARE-forecast/BVRE-data/bvre-platform-data/BVR_maintenance_log.txt", "misc_data_files/BVR_maintenance_log.txt")

```

```{r Read in file, include=FALSE}

  BVRDATA_COL_NAMES = c("DateTime", "RECORD", "CR6Battery_V", "CR6Panel_Temp_C", "ThermistorTemp_C_1",
                        "ThermistorTemp_C_2", "ThermistorTemp_C_3", "ThermistorTemp_C_4", "ThermistorTemp_C_5",
                        "ThermistorTemp_C_6", "ThermistorTemp_C_7", "ThermistorTemp_C_8", "ThermistorTemp_C_9",
                        "ThermistorTemp_C_10","ThermistorTemp_C_11","ThermistorTemp_C_12","ThermistorTemp_C_13",
                        "RDO_mgL_6", "RDOsat_percent_6", "RDOTemp_C_6", "RDO_mgL_13",
                        "RDOsat_percent_13", "RDOTemp_C_13", "EXO_Date", "EXO_Time", "EXOTemp_C_1.5", "EXOCond_uScm_1.5",
                        "EXOSpCond_uScm_1.5", "EXOTDS_mgL_1.5", "EXODOsat_percent_1.5", "EXODO_mgL_1.5", "EXOChla_RFU_1.5",
                        "EXOChla_ugL_1.5", "EXOBGAPC_RFU_1.5", "EXOBGAPC_ugL_1.5", "EXOfDOM_RFU_1.5", "EXOfDOM_QSU_1.5",
                        "EXOTurbidity_FNU_1.5", "EXOTSS_mg_1.5","EXOPressure_psi", "EXODepth_m", "EXOBattery_V",
                        "EXOCablepower_V", "EXOWiper_V", "LvlPressure_psi_13", "LvlTemp_C_13")
  

  # read catwalk data and maintenance log
  # NOTE: date-times throughout this script are processed as UTC
  
  bvrdata1 <- read_csv("misc_data_files/bvre-waterquality.csv", skip=1, col_names = BVRDATA_COL_NAMES,
                       col_types = cols(.default = col_double(), DateTime = col_datetime()))
  
  bvrdata2<-read_csv("misc_data_files/BVRmanualplatform.csv", skip=1, col_names = BVRDATA_COL_NAMES,
                     col_types = cols(.default = col_double(), DateTime = col_datetime()))

  #bad headers so remove them
  
  bvrdata1<-bvrdata1%>%filter(grepl("^20", DateTime)) #keep only the right TIMESTAMP rows 
  
  
  bvrdata= bvrdata1%>%
    rbind(.,bvrdata2)%>% #combine manual and most recent files
    drop_na(DateTime)%>% #take out the rows with blank timestamps
    distinct(DateTime, .keep_all= TRUE) #taking out the duplicate values 
  
  # Change NaN into NA
  bvrdata[sapply(bvrdata, is.nan)] <- NA
  
   # Order the data frame by date from oldest to youngest
   bvrdata=bvrdata[order(bvrdata$DateTime),]
  
```

```{r Check for daily gaps and record gaps, include=FALSE}

#order data by DateTime
BVRdata2=bvrdata
BVRdata2$DOY=yday(BVRdata2$DateTime)
# Add depth 
BVRdata2=BVRdata2%>%mutate(Depth_m_13=(LvlPressure_psi_13*0.70455))
```

## Check for gaps in the data frame
This identifies if there are any daily data gaps in the long-term record
```{r Check for daily gaps, echo=FALSE}
for(i in 2:nrow(BVRdata2)){ #this identifies if there are any data gaps in the long-term record, and where they are by record number
  if(BVRdata2$DOY[i]-BVRdata2$DOY[i-1]>1){
    print(c(BVRdata2$DateTime[i-1],BVRdata2$DateTime[i]))
  }
}
```
This identifies if there are any sub-daily gaps in the long-term record. 
Most of these gaps happen when we change the program on the data logger. 
```{r Check for sub daily gaps, echo=FALSE}
BVR2=BVRdata2%>%filter(!is.na(RECORD))
for(i in 2:length(BVR2$RECORD)){ #this identifies if there are any data gaps in the long-term record, and where they are by record number
  if(abs(BVR2$RECORD[i]-BVR2$RECORD[i-1])>1){
    print(c(BVR2$DateTime[i-1],BVR2$DateTime[i]))
  }
}
```

```{r Run the QAQC function, include=FALSE}
# run standard qaqc function from BVR_catwalk_QAQC_function_2020_2023.R

# run standard qaqc these are where the data entered in the function are defined
data_file <- bvrdata
maintenance_file <-  "misc_data_files/BVR_maintenance_log.txt" #this is the maintenance log for QAQC purposes
output_file <-  "BVR_platform_data_2020_2023.csv"
start_date <-NULL
end_date <- NULL

# Run the QAQC function
qaqc_bvr(data_file,maintenance_file, output_file, start_date, end_date)

```

```{r Make Maintenance Log for pub, include=FALSE}
# Make the Maintenance Log into a csv and add Reservoir and Site column 
  Log <- read.csv(maintenance_file)
 names(Log) = c("Station", "DateTime_start","DateTime_end", "Parameter", "ColumnNumber","Flag", "FlagColumn", "Notes") #finalized column names
Log$Reservoir= "BVR"#add reservoir name for EDI archiving
Log$Site=50 #add site column for EDI archiving

Log=Log[,c(9:10,1:8)]

Log_final <- Log[Log$DateTime_start<ymd_hms(current_time_start),]
 
write.csv(Log_final, "BVR_MaintenanceLog_2020_2023.csv", row.names=F, quote=F)
```


## Read in the QAQC File and Check it out
This section reads in the QAQC file and then you can look at the head, tail and structure. 
Make sure the last row is Dec. 31 23:50 of the publishing year. There should be 85 columns unless a new one has been added. 
```{r Read in QAQC file and look at it, echo=FALSE}
# read in qaqc function output

bvrdata <- read_csv(output_file)

# what does the beginning look like
head(bvrdata)
# Make sure it goes to Dec 31st 23:50 of the previous year or your ending period
tail(bvrdata)
# check out the structure
str(bvrdata)
```

## Information for EDI methods text
This is information that is included in the methods file for EDI 

The minimum water level for BVR was `r min(bvrdata$LvlDepth_m_13, na.rm=T)` and the maximum water depth was `r max(bvrdata$LvlDepth_m_13, na.rm=T)`.

The median water level was `r median(bvrdata$LvlDepth_m_13, na.rm=T)` and the mean water level was `r mean(bvrdata$LvlDepth_m_13, na.rm=T)`.

### Flag Frequency
Let's look at the flag Frequency for each variable. As a reminder here are the flag codes
 Flag values
 
 0: no flag
 
 1: value removed due to maintenance and set to NA
 
 2: negative or outlier value removed and set to NA, see Methods section for more detail on QAQC process
 
 3: negative values set to 0 except for temperature
 
 4: value removed due to fouling and set to NA
 
 5: questionable value but left in the dataset
 
 6: Values adjusted using a linear or square root function to match high-resolution CTD profiles and corrected other affected observations on the same sensor
 
 7: missing data

```{r Check out the flags, echo=FALSE}

#make sure no NAS in the Flag columns
Flags=bvrdata%>%
  select(DateTime, starts_with("Flag"))

RowsNA=Flags[!complete.cases(Flags), ] # Keep only the complete rows

#check the flag column
Flags=bvrdata%>%
  select(starts_with("Flag"))

# Make a table with the number of times a flag was used
for(f in 1:(ncol(Flags))){
  #print(colnames(Flags[f]))
  print(table(Flags[,f], useNA = "always"))
}
```

```{r Filter for current year and daily average, include=FALSE}

# Raw files
current_raw <- BVRdata2%>%
  filter(DateTime>=ymd_hms(current_time_start) & DateTime<ymd_hms(current_time_end))

current <- bvrdata%>%
  filter(DateTime>=ymd_hms(current_time_start) & DateTime<ymd_hms(current_time_end))

daily <- bvrdata%>% 
  group_by( Date = as.Date(DateTime)) %>% 
  summarise_if(is.numeric, mean, na.rm=T)%>%
  mutate(Year = as.factor(year(Date)),
         Month = month(Date),
         Time = "12:00:00")%>%
  mutate(DateTime= paste0(Date, Time, sep=" "))%>%
  mutate(DateTime=ymd_hms(DateTime))

  
bvrdata<-bvrdata%>%
  mutate(Year=year(DateTime))

colors <- c("raw" = "red", "QAQCd" = "black")
# colors for comparing Thermistor, RDO and Pressure sensor
colors2 <- c("Therm"="magenta","RDO"="dodgerblue2" ,"Pressure"="black")
```

```{r Plot functions, echo=FALSE}
# plotting function for each plot

all_plot<-function(Var,y_lab){
 if(Var=="ThermistorTemp_C_6"|Var=="ThermistorTemp_C_13"){
   
    if (Var=="ThermistorTemp_C_6"){
      Var2="RDOTemp_C_6"
      Switch=F # Used to switch on and off the layer for the pressure sensor
    }else if (Var=="ThermistorTemp_C_13"){
      Var2="RDOTemp_C_13"
      Var3="LvlTemp_C_13"
      Switch=T # Used to switch on and off the layer for the pressure sensor
    }
  
    all<- ggplot() +
      geom_scattermore(data=BVRdata2, aes_string(x="DateTime", y=Var, color=shQuote("raw")))+
      geom_scattermore(data=bvrdata, aes_string(x="DateTime", y=Var, color=shQuote("QAQCd")))+
      ggtitle("All",Var) +
      labs(y = y_lab,
           color = "Legend") +
      scale_color_manual(values = colors)+
      theme_bw()
    
    cur<- ggplot() +
      geom_scattermore(data=current_raw, aes_string(x="DateTime", y=Var, color=shQuote("raw")), pointsize = 3)+
      geom_scattermore(data=current, aes_string(x="DateTime", y=Var, color=shQuote("QAQCd")), pointsize = 3) +
      ggtitle("Current",Var) +
      labs(y = y_lab,
           color = "Legend") +
      scale_color_manual(values = colors)+
      theme_bw()
    
    # density plot
    den <-ggplot(data = daily, aes_string(x = Var, group = "Year", fill = "Year"))+
      geom_density(alpha=0.5)+
      xlab("Daily avg.")+
      #xlim(0,0.5)+
      ggtitle("All",Var) +
      theme_bw()
    
    # box plot
    box <-ggplot(data = daily, aes_string(x = "Year", y = Var, group = "Year", fill = "Year"))+
      geom_boxplot()+
      #geom_jitter(alpha = 0.1)+
      ylab(y_lab)+
      #ylim(0,0.3)+
      ggtitle("Boxplot",Var) +
      theme_bw()  
    
    
    # graph all
    com_all<-ggplot(data = bvrdata, aes_string(x = "DateTime", y = Var)) +
      geom_scattermore(aes_string(y=Var, color=shQuote("Therm")))+ 
      geom_scattermore(aes_string(y=Var2, color=shQuote("RDO")))+
      {if(Switch)geom_scattermore(aes_string(y=Var3, color=shQuote("Pressure")))}+ # print layer if Switch is TRUE
    ggtitle(paste0("All Water Temp from"," ",Var,", ",Var2)) +
      labs(y = y_lab,
           color = "Legend") +
      scale_color_manual(values = colors2)+
      theme_bw()
    
    #Just the current year
    com_curr<-ggplot(data = current, aes_string(x = "DateTime", y = Var)) +
      geom_scattermore(aes_string(y=Var, color=shQuote("Therm")), pointsize = 3)+ 
      geom_scattermore(aes_string(y=Var2, color=shQuote("RDO")), pointsize = 3)+
      {if(Switch)geom_scattermore(aes_string(y=Var3, color=shQuote("Pressure")), pointsize = 3)}+ # print layer if Switch is TRUE
    ggtitle(paste0("Current Water Temp from"," ",Var,", ",Var2)) +
      labs(y = y_lab,
           color = "Legend") +
      scale_color_manual(values = colors2)+
      theme_bw()
    
  }else{
    all<- ggplot() +
      geom_scattermore(data=BVRdata2, aes_string(x="DateTime", y=Var, color=shQuote("raw")))+
      geom_scattermore(data=bvrdata, aes_string(x="DateTime", y=Var, color=shQuote("QAQCd")))+
      ggtitle("All",Var) +
      labs(y = y_lab,
           color = "Legend") +
      scale_color_manual(values = colors)+
      theme_bw()
    
    cur<- ggplot() +
      geom_scattermore(data=current_raw, aes_string(x="DateTime", y=Var, color=shQuote("raw")), pointsize = 3)+
      geom_scattermore(data=current, aes_string(x="DateTime", y=Var, color=shQuote("QAQCd")), pointsize = 3) +
      ggtitle("Current",Var) +
      labs(y = y_lab,
           color = "Legend") +
      scale_color_manual(values = colors)+
      theme_bw()
    
    # density plot
    den <-ggplot(data = daily, aes_string(x = Var, group = "Year", fill = "Year"))+
      geom_density(alpha=0.5)+
      xlab("Daily avg.")+
      #xlim(0,0.5)+
      ggtitle("All",Var) +
      theme_bw()
    
    # box plot
    box <-ggplot(data = daily, aes_string(x = "Year", y = Var, group = "Year", fill = "Year"))+
      geom_boxplot()+
      #geom_jitter(alpha = 0.1)+
      ylab(y_lab)+
      #ylim(0,0.3)+
      ggtitle("Boxplot",Var) +
      theme_bw()
  }
    
    if(Var=="ThermistorTemp_C_6"|Var=="ThermistorTemp_C_13"){
    newlist <- list(all,cur,den,box,com_all,com_curr) # have to list all outputs under one name
    
    }else{
      newlist <- list(all,cur,den,box)
    }
    return(newlist)
}
```

## QAQC Plots
### Temperature
```{r Temperature data, echo=FALSE, warning = FALSE, results='hide'}
# for loop through all the temp data
for(i in names(bvrdata)[c(4:16,19,22:23)]){
  print(all_plot(Var=i, y_lab = expression(''*~degree*C*'')))
}
```

```{r All Temperature, echo=FALSE, warning = FALSE, results='hide'}

colors3 <-c("1"="firebrick1", "2"="DarkOrange1", "EXO_1.5m"="yellow","3"="gold", 
                                  "4"="greenyellow", "5"="medium sea green", "6"="sea green",
                                  "7"="DeepSkyBlue4", "8"="blue2", "9"="cornflowerblue", 
            "10"="darkslateblue","11"="magenta2", "12"="darkmagenta", "13"="black")

# Take out Temperature values 

  All_temp<-bvrdata%>%
    select(DateTime, starts_with("Ther"), starts_with("EXOTemp"))%>%
    pivot_longer(-c(DateTime), names_to="Sensor", values_to="Reading", values_drop_na=TRUE)%>%
    mutate(DateTime=ymd_hms(DateTime))
  
  
  ggplot(All_temp)+
    geom_scattermore(aes(x=DateTime, y=Reading))+
    facet_wrap(.~factor(Sensor, levels=c("ThermistorTemp_C_1", "ThermistorTemp_C_2", "EXOTemp_C_1.5", "ThermistorTemp_C_3", "ThermistorTemp_C_4","ThermistorTemp_C_5","ThermistorTemp_C_6","ThermistorTemp_C_7","ThermistorTemp_C_8","ThermistorTemp_C_9","EXOTemp_C_9","ThermistorTemp_C_10","ThermistorTemp_C_11","ThermistorTemp_C_12","ThermistorTemp_C_13")))+
    theme_bw()
  
# All on one plot
    ggplot(bvrdata,aes(x = DateTime))+
    geom_line(aes(y=ThermistorTemp_C_1, color="1"))+
    geom_line(aes(y=ThermistorTemp_C_2, color="2"))+
    geom_line(aes(y=EXOTemp_C_1.5, color="EXO_1.5m")) +
    geom_line(aes(y=ThermistorTemp_C_3, color="3"))+
    geom_line(aes(y=ThermistorTemp_C_4, color="4"))+
    geom_line(aes(y=ThermistorTemp_C_5, color="5"))+
    geom_line(aes(y=ThermistorTemp_C_6, color="6"))+
    geom_line(aes(y=ThermistorTemp_C_7, color="7"))+
    geom_line(aes(y=ThermistorTemp_C_8, color="8"))+
    geom_line(aes(y=ThermistorTemp_C_9, color="9"))+
    geom_line(aes(y=ThermistorTemp_C_10, color="10"))+
    geom_line(aes(y=ThermistorTemp_C_11, color="11"))+
    geom_line(aes(y=ThermistorTemp_C_12, color="12"))+
    geom_line(aes(y=ThermistorTemp_C_13, color="13"))+
    ggtitle("All Temperature Profile") +
    labs(y = expression(''*~degree*C*''),
           color = "Legend") +
      scale_color_manual(values = colors3)+
      theme_bw()
  
# This is all the temps and just the current year
    ggplot(current,aes(x = DateTime))+
    geom_line(aes(y=ThermistorTemp_C_1, color="1"))+
    geom_line(aes(y=ThermistorTemp_C_2, color="2"))+
    geom_line(aes(y=EXOTemp_C_1.5, color="EXO_1.5m")) +
    geom_line(aes(y=ThermistorTemp_C_3, color="3"))+
    geom_line(aes(y=ThermistorTemp_C_4, color="4"))+
    geom_line(aes(y=ThermistorTemp_C_5, color="5"))+
    geom_line(aes(y=ThermistorTemp_C_6, color="6"))+
    geom_line(aes(y=ThermistorTemp_C_7, color="7"))+
    geom_line(aes(y=ThermistorTemp_C_8, color="8"))+
    geom_line(aes(y=ThermistorTemp_C_9, color="9"))+
    geom_line(aes(y=ThermistorTemp_C_10, color="10"))+
    geom_line(aes(y=ThermistorTemp_C_11, color="11"))+
    geom_line(aes(y=ThermistorTemp_C_12, color="12"))+
    geom_line(aes(y=ThermistorTemp_C_13, color="13"))+
    ggtitle("Current Temperature Profile") +
    labs(y = expression(''*~degree*C*''),
           color = "Legend") +
      scale_color_manual(values = colors3)+
      theme_bw()
  
```

### Depth
```{r Pressure Sensor, echo=FALSE, warning = FALSE, results='hide'}  
### Plotting depth from pressure sensor 
   
for(i in names(bvrdata)[c(42,37)]){
  print(all_plot(Var=i, y_lab = "meters"))
}

```

### Dissolved Oxygen
```{r DO, echo=FALSE, warning = FALSE, results='hide'}
for(i in names(bvrdata)[c(17:18,20:21,28,27)]){
  print(all_plot(Var=i, y_lab = "mg/L or % sat"))
}
```

### Chlorophyll 
```{r Check the EXO Chla, echo=FALSE, warning = FALSE, results='hide'}

all_plot(Var="EXOChla_ugL_1.5", y_lab = "ug/L")

# chl and phyco visual qaqc-plot to see if everything looks right
 #take out the NAs
 data_comp <- daily[!is.na(daily$EXOChla_ugL_1.5), ]  
 
 ggplot()+
   geom_point(data=bvrdata, aes(x=DateTime, y=EXOChla_ugL_1.5))+
   geom_line(data=data_comp, aes(x=DateTime, y=EXOChla_ugL_1.5), col="green")+
   ggtitle("Compare 10 minute observations to Daily mean")
 
 
all_plot(Var="EXOChla_RFU_1.5", y_lab="RFU")

 #take out the NAs
 data_comp <- daily[!is.na(daily$EXOChla_RFU_1.5), ]  
 
 ggplot()+
   geom_point(data=bvrdata, aes(x=DateTime, y=EXOChla_RFU_1.5))+
   geom_line(data=data_comp, aes(x=DateTime, y=EXOChla_RFU_1.5), col="green")+
   ggtitle("Compare 10 minute observations to Daily mean")
```

### Phycocanin
```{r Check out the Phyco in EXO, echo=FALSE, warning = FALSE, results='hide'}
all_plot(Var="EXOBGAPC_RFU_1.5", y_lab="RFU")

 #take out the NAs
 data_comp <- daily[!is.na(daily$EXOBGAPC_RFU_1.5), ]  
 
 ggplot()+
   geom_point(data=bvrdata, aes(x=DateTime, y=EXOBGAPC_RFU_1.5))+
   geom_line(data=data_comp, aes(x=DateTime, y=EXOBGAPC_RFU_1.5), col="blue")+
   ggtitle("Compare 10 minute observations to Daily mean")
 
  all_plot(Var="EXOBGAPC_ugL_1.5", y_lab="ug/L")

 #take out the NAs
 data_comp <- daily[!is.na(daily$EXOBGAPC_ugL_1.5), ]  
 
 ggplot()+
   geom_point(data=bvrdata, aes(x=DateTime, y=EXOBGAPC_ugL_1.5))+
   geom_line(data=data_comp, aes(x=DateTime, y=EXOBGAPC_ugL_1.5), col="blue")+
   ggtitle("Compare 10 minute observations to Daily mean")
```

### fDOM
```{r fdom EXO sensor, echo=FALSE, warning = FALSE, results='hide'}
for(i in names(bvrdata)[33:34]){
  print(all_plot(Var=i, y_lab = "RFU or QSU"))
}
```

### Conductivity, Specific Conductivity, TDS
```{r Cond Spcond and TDS, echo=FALSE, warning = FALSE, results='hide'}
for(i in names(bvrdata)[24:26]){
  print(all_plot(Var=i, y_lab = "uScm or mg/L"))
}
```

### Turbidity 
```{r turbidity, echo=FALSE, warning = FALSE, results='hide'}
all_plot(Var="EXOTurbidity_FNU_1.5", y_lab="FNU")
```
