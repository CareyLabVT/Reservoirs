---
title: "Chemistry"
author: "Abby Lewis"
date: "2022-09-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(akima)
library(colorRamps)
source("custom_facets.R")

#Define drawdown lines
lines = data.frame(Dates = as.Date(c("2022-06-28", "2022-05-19","2022-05-28", "2022-07-01")), desc = c("closed","opened", "decreasing", "stable"), type = c("close","open","open","close"), status = c("init","init","final","final"), Year = 2022)
```

```{r}
carbon = read_csv("../NutrientData/collation/2022/2022_TOC_collation.csv")
carbon%>%
  filter(Reservoir=="BVR")%>%
  mutate(Date = as.Date(DateTime, format = "%m/%d/%y %H:%M"))%>%
  select(Depth_m, Site, Date, DOC_mgL, DIC_mgL, DC_mgL, DN_mgL)%>%
  group_by(Date, Depth_m)%>%
  filter(40%in%Site)%>%
  pivot_longer(cols = contains("_mg"))%>%
  pivot_wider(names_from = Site, values_from =value, names_prefix = "Site_")%>%
  filter(!is.na(Site_40),
         !is.na(Site_50))%>%
  ggplot(aes(x = Site_50, y = Site_40))+
  geom_point()+
  geom_abline(slope = 1, intercept = 0, alpha = 0.7, lty = 2) +
  facet_wrap_equal(~name, scales = "free")

nuts = read_csv("../NutrientData/collation/2022/2022_soluble_NP_collation.csv")
nuts%>%
  filter(Reservoir=="BVR")%>%
  mutate(Date = as.Date(DateTime, format = "%m/%d/%y %H:%M"))%>%
  select(Depth_m, Site, Date, NH4_ugL, PO4_ugL, NO3NO2_ugL)%>%
  group_by(Date, Depth_m)%>%
  filter(40%in%Site)%>%
  pivot_longer(cols = contains("_ug"))%>%
  pivot_wider(names_from = Site, values_from =value, names_prefix = "Site_")%>%
  filter(!is.na(Site_40),
         !is.na(Site_50))%>%
  ggplot(aes(x = Site_50, y = Site_40))+
  geom_point()+
  geom_abline(slope = 1, intercept = 0, alpha = 0.7, lty = 2) +
  facet_wrap_equal(~name, scales = "free")

chem = nuts%>%
  full_join(carbon)%>%
  filter(Reservoir=="BVR",
         Site == 50)%>%
  mutate(DateTime = as.Date(DateTime, format = "%m/%d/%y %H:%M"))
```


```{r}
inUrl1  <- "https://pasta.lternet.edu/package/data/eml/edi/199/10/aa2ccc23688fc908f9d61cb217210a3d" 
infile1 <- tempfile()
try(download.file(inUrl1,infile1,method="curl"))
if (is.na(file.size(infile1))) download.file(inUrl1,infile1,method="auto")

                   
 dt1 <-read.csv(infile1,header=F 
          ,skip=1
            ,sep=","  
        , col.names=c(
                    "Reservoir",     
                    "Site",     
                    "DateTime",     
                    "Depth_m",     
                    "Rep",     
                    "TN_ugL",     
                    "TP_ugL",     
                    "NH4_ugL",     
                    "NO3NO2_ugL",     
                    "SRP_ugL",     
                    "DOC_mgL",     
                    "DIC_mgL",     
                    "DC_mgL",     
                    "DN_mgL",     
                    "Flag_DateTime",     
                    "Flag_TN",     
                    "Flag_TP",     
                    "Flag_NH4",     
                    "Flag_NO3NO2",     
                    "Flag_SRP",     
                    "Flag_DOC",     
                    "Flag_DIC",     
                    "Flag_DC",     
                    "Flag_DN"    ), check.names=TRUE)
               
unlink(infile1)

dt1 = dt1%>%
  mutate(DateTime=as.Date(DateTime))%>%
  rename(PO4_ugL = SRP_ugL)

chem_full = chem%>%
  full_join(dt1)%>%
  filter(Reservoir=="BVR",
         Site==50,
         year(DateTime)%in% c(2021,2022))

chem_full$Date_22<-chem_full$DateTime
chem_full$Year = year(chem_full$DateTime)
year(chem_full$Date_22)<-2022

chem_full%>%
  filter(Reservoir=="BVR", Site==50)%>%
  ggplot(aes(x = Date_22, y = PO4_ugL, color = as.factor(Depth_m)))+
  geom_vline(data=lines,aes(xintercept = Dates, lty = status), show.legend = F)+
  geom_line()+
  geom_point()+
  facet_wrap(~Year)

chem_full%>%
  filter(Reservoir=="BVR", Site==50)%>%
  ggplot(aes(x = Date_22, y = NH4_ugL, color = as.factor(Depth_m)))+
  geom_vline(data=lines,aes(xintercept = Dates, lty = status), show.legend = F)+
  geom_line()+
  geom_point()+
  facet_wrap(~Year)

chem_full%>%
  filter(Reservoir=="BVR", Site==50)%>%
  ggplot(aes(x = Date_22, y = NO3NO2_ugL, color = as.factor(Depth_m)))+
  geom_vline(data=lines,aes(xintercept = Dates, lty = status), show.legend = F)+
  geom_line()+
  geom_point()+
  facet_wrap(~Year)
```

```{r}
chem_boxplot = chem_full%>%
  filter(Reservoir=="BVR", Site==50,
         month(DateTime)>4,month(DateTime)<10)%>%
  mutate(period = factor(ifelse(Date_22<"2022-05-19","before May 19","after"),levels = c("before May 19","after")),
         Year = as.factor(Year))%>%
  group_by(DateTime)%>%
  filter(Depth_m==0.1|Depth_m == max(Depth_m))%>%
  mutate(Layer = ifelse(Depth_m==0.1,"top (0.1 m)","bottom (lowest depth sampled)"))

library(ggpubr)
p1 = chem_boxplot%>%
  ungroup()%>%
  filter(Layer == "top (0.1 m)")%>%
  select(period, PO4_ugL,NH4_ugL,NO3NO2_ugL,DOC_mgL,Year,Layer)%>%
  pivot_longer(cols = c("PO4_ugL","NH4_ugL","NO3NO2_ugL","DOC_mgL"))%>%
  ggplot(aes(x = period, y = value,color = Year))+
  geom_boxplot(outlier.alpha = 0)+
  geom_point(position = position_jitterdodge())+
  facet_grid(cols = vars(Layer), rows = vars(name), scales= "free")+
  stat_compare_means(label = "p.format",vjust = -1)+
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank())+
  scale_y_continuous(expand = expansion(mult = c(0.1,.4)))

p2 = chem_boxplot%>%
  ungroup()%>%
  filter(Layer == "bottom (lowest depth sampled)")%>%
  select(period, PO4_ugL,NH4_ugL,NO3NO2_ugL,DOC_mgL,Year,Layer)%>%
  pivot_longer(cols = c("PO4_ugL","NH4_ugL","NO3NO2_ugL","DOC_mgL"))%>%
  ggplot(aes(x = period, y = value,color = Year))+
  geom_boxplot(outlier.alpha = 0)+
  geom_point(position = position_jitterdodge())+
  facet_grid(cols = vars(Layer), rows = vars(name), scales= "free")+
  stat_compare_means(label = "p.format",vjust = -1)+
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank())+
  scale_y_continuous(expand = expansion(mult = c(0.1,.4)))

ggarrange(p1,p2, common.legend = T, legend = "bottom")
```


Heatmaps
```{r}
cat_long = read.csv("~/Desktop/github/Reservoirs/Data/DataAlreadyUploadedToEDI/EDIProductionFiles/MakeEML_BVRplatform/2022/BVR_longoutput_FLARE_2020_2021.csv")

sensor_depth = cat_long%>%
  select(DateTime,Reservoir_depth)%>%
  unique()%>%
  mutate(DateTime = as.POSIXct(DateTime))%>%
  rename(WaterLevel = Reservoir_depth)%>%
  filter(DateTime>=min(chem_full$DateTime, na.rm = T),
         DateTime<=max(chem_full$DateTime, na.rm = T),
         WaterLevel>7.5)%>%
  arrange(DateTime)%>%
  filter(!lag(WaterLevel)-WaterLevel>0.2)%>%
  mutate(Date = as.Date(DateTime))%>%
  group_by(Date)%>%
  summarize(WaterLevel = mean(WaterLevel))%>%
  mutate(Year = year(Date),
         Site = 50)%>%
  group_by(Site)%>%
  mutate(max = max(WaterLevel))%>%
  filter(month(Date)>2,
         month(Date)<10)

chem_bvr = chem_full%>%
  left_join(sensor_depth%>%rename(DateTime=Date))%>%select(-max)%>%
  mutate(height = WaterLevel-Depth_m)%>%
  arrange(height)%>%
  filter(!is.na(height),
         month(DateTime)>2,
         month(DateTime)<10)

chem_bvr%>%
  filter(Year==2021,month(DateTime)==9)

lines = data.frame(Dates = as.Date(c("2022-06-28", "2022-05-19","2022-05-28", "2022-07-01")), desc = c("closed","opened", "decreasing", "stable"), type = c("close","open","open","close"), status = c("init","init","final","final"))

vars = c("NH4_ugL","PO4_ugL","DOC_mgL","NO3NO2_ugL")
years = c(2021,2022)

for(var in vars){
  interp = data.frame(x = NA, y = NA, z = NA, Site = NA)
  bvr_comb = chem_bvr%>%
    filter(Depth_m==1000000)
  Sites = c(50)
  for(year in years){
    for(site in Sites){
      bvr<- chem_bvr%>%
        mutate(Year = year(DateTime),
               Date = as.Date(DateTime))%>%
        filter(Site == site,
               !is.na(get(var)),
               !is.na(Depth_m),
               Year==year)%>%
        arrange(NH4_ugL)
      
      bvr_interp <- interp2xyz(interp(bvr$Date,bvr$height,bvr[[var]],xo = seq(min(bvr$Date), max(bvr$Date), .1),yo = seq(min(bvr$height), max(bvr$height), by = .01), duplicate = "mean"),data.frame = T)
      
      interp = interp%>%
        full_join(bvr_interp%>%mutate(Site=site))
      bvr_comb = bvr_comb%>%
        full_join(bvr)%>%
        mutate(max = max(height))
    }
  }
  interp = interp%>%
    filter(!is.na(Site))
  
  #Heatmap
  jpeg(paste0("./Figs/BVR_",var,"_heatmap_2022.jpeg"),width = 8, height = 4, units = "in", res = 300)
  p = interp%>%
    mutate(x = as.Date(x, origin = "1970-01-01"),
           Year = year(x))%>%
    ggplot(aes(x=x))+
    geom_raster(aes(fill = z, y = y))+
    scale_y_continuous(expand = c(0,0))+
    labs(x = "", y = "Height above sediments (m)")+
    scale_fill_gradientn(colours = if(var%in%c("DO_mgL","DO_pSat","ORP_mV")){rev(blue2green2red(100))}else{blue2green2red(100)}, na.value="gray", name = var)+
    geom_ribbon(data = sensor_depth, aes(x = Date, ymin= WaterLevel, ymax = max), fill = "white")+
    geom_vline(data=lines,aes(xintercept = Dates, lty = status), show.legend = F)+
  scale_linetype_manual(values = c("solid","dashed"))+
    scale_x_date(expand = c(0,0))+
    theme_classic()+
    theme(panel.border = element_rect(fill = NA))+
    geom_point(data = bvr_comb, aes(x = Date, y = max), shape = 25, fill = "black", color = "white", size  =2)+
    facet_grid(rows= vars(Site),
               cols = vars(Year),
               scales = "free",
               space = "free"
               )
  print(p)
  dev.off()
}
```

Compare P, DOC, and fluora
```{r}
#Load data
fluora_22 = read.csv("./Data/FluoroProbe_2022_working.csv")

inUrl1  <- "https://pasta.lternet.edu/package/data/eml/edi/272/6/6b3151c0fdd913e02641363c2b00ae57" 
infile1 <- tempfile()
try(download.file(inUrl1,infile1,method="curl"))
if (is.na(file.size(infile1))) download.file(inUrl1,infile1,method="auto")

                   
 dt1 <-read.csv(infile1,header=F 
          ,skip=1
            ,sep=","  
        , col.names=c(
                    "Reservoir",     
                    "Site",     
                    "DateTime",     
                    "Depth_m",     
                    "GreenAlgae_ugL",     
                    "Bluegreens_ugL",     
                    "BrownAlgae_ugL",     
                    "MixedAlgae_ugL",     
                    "YellowSubstances_ugL",     
                    "TotalConc_ugL",     
                    "Transmission",     
                    "Temp_degC",     
                    "RFU_525nm",     
                    "RFU_570nm",     
                    "RFU_610nm",     
                    "RFU_370nm",     
                    "RFU_590nm",     
                    "RFU_470nm",     
                    "Flag_GreenAlgae",     
                    "Flag_BluegreenAlgae",     
                    "Flag_BrownAlgae",     
                    "Flag_MixedAlgae",     
                    "Flag_TotalConc",     
                    "Flag_Temp",     
                    "Flag_Transmission",     
                    "Flag_525nm",     
                    "Flag_570nm",     
                    "Flag_610nm",     
                    "Flag_370nm",     
                    "Flag_590nm",     
                    "Flag_470nm"    ), check.names=TRUE)
               
unlink(infile1)

#Combine current and historical data
fluora = fluora_22%>%
  full_join(dt1)

fluora_surface=fluora%>%
  filter(Reservoir=="BVR",
         Site==50,
         Depth_m<1)%>%
  mutate(DateTime = as.Date(DateTime))%>%
  group_by(DateTime)%>%
  mutate(min_depth = min(Depth_m))%>%
  filter(Depth_m==min_depth)


fluora_surface$DateTime

sum_plot = chem_full%>%
  filter(Depth_m ==0.1)%>%
  select(DateTime, PO4_ugL,DOC_mgL)%>%
  full_join(fluora_surface%>%
              filter(year(DateTime)%in% c(2021,2022)))%>%
  select(DateTime, PO4_ugL,DOC_mgL,Bluegreens_ugL,TotalConc_ugL)%>%
  pivot_longer(cols = c(PO4_ugL,DOC_mgL,Bluegreens_ugL,TotalConc_ugL))%>%
  filter(!is.na(value),
         month(DateTime)>4,
         month(DateTime)<9)%>%
  mutate(Year = year(DateTime))%>%
  mutate(name = factor(name, levels=c("PO4_ugL","TotalConc_ugL","Bluegreens_ugL","DOC_mgL")))

maxes = sum_plot%>%
  group_by(name, Year)%>%
  summarize(max_date = DateTime[which.max(value)])%>%
  filter(Year=="2022")

# New facet label names for sum_plot
fac.labs <- c("SRP (ug/L)","Total phyto. (ug/L)","Cyanobacteria (ug/L)","DOC (mg/L)")
names(fac.labs) <- c("PO4_ugL","TotalConc_ugL","Bluegreens_ugL","DOC_mgL")

jpeg("./Figs/Abby_money_plot_for_WVWA.jpeg", res = 300, width = 6.5, height = 5.6, units = "in")
sum_plot%>%
  ggplot(aes(x = DateTime, y = value, color = name))+
  geom_point()+
  geom_line()+
  geom_vline(aes(xintercept = max_date, color = name), data = maxes, lwd = 2)+
  geom_vline(data=lines,aes(xintercept = Dates, lty = status), show.legend = F)+
  scale_linetype_manual(values = c("solid","dashed"))+
  facet_grid(rows = vars(name), cols = vars(Year), scales = "free", switch = "y",
             labeller = labeller(name = fac.labs))+
  theme_bw()+
  theme(strip.placement = "outside", legend.position = "none",
        strip.text.x = element_text(
        size = 12, face = "bold"
        ),
        strip.background = element_blank(
     ))+
  ylab("")
dev.off()
```

