---
title: "Physics"
author: "Abby Lewis"
date: "2022-08-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rLakeAnalyzer)
library(lubridate)
```

```{r}

adrienne = read.csv("./Data/BVR_thermistor_bin_whole.txt", sep = "\t")

cat_long = adrienne%>%
  pivot_longer(!datetime,names_prefix = "wtr_")%>%
  rename(Temp_C = value,
         Depth_m = name)%>%
  mutate(Depth_m = as.numeric(Depth_m))

#Load bathymetry
bathy = read.csv("./Data/Bathymetry_comb.csv")%>%
  filter(Reservoir == "BVR")

ctd_depths = cat_long%>%
  mutate(Date = as.Date(as.POSIXct(datetime)))%>%
  filter(!is.na(Temp_C))%>%
  group_by(Date)%>%
  summarize(WaterLevel = max(Depth_m))

flexible_bathy = ctd_depths%>%
  mutate(Reservoir = "BVR")%>%
  full_join(bathy)%>%
  group_by(Date)%>%
  mutate(Depth_m = Depth_m - (max(Depth_m)-unique(WaterLevel)) + 1)%>%
  filter(Depth_m>=0)

catwalk_format = cat_long%>%
  filter(!is.na(Temp_C))%>%
  mutate(Date = as.Date(as.POSIXct(datetime)))

schmidts = c()
for(date in unique(catwalk_format$Date)){
  temps = catwalk_format%>%
    filter(Date == date)
  baths = flexible_bathy%>%
    filter(Date==date)
  schmidts = c(schmidts, schmidt.stability(wtr = temps$Temp_C, depths = temps$Depth_m, bthA = baths$SA_m2, bthD = baths$Depth_m, sal = rep(0,length(temps$Temp_C))))
}

schmidt_df = data.frame(Date = unique(catwalk_format$Date), Schmidt = schmidts)%>%
  mutate(Year = year(Date))
schmidt_df$Date_22 = schmidt_df$Date
year(schmidt_df$Date_22)=2022

schmidt_df%>%
  arrange(Date)

###
# PLOT RESULTS
###
lines = data.frame(Dates = as.Date(c("2022-06-28", "2022-05-19","2022-05-28", "2022-07-01")), desc = c("closed","opened", "decreasing", "stable"), type = c("close","open","open","close"), status = c("init","init","final","final"), Year = 2022)

jpeg("./Figs/Schmidt_exo.jpg",res = 300, units = "in",width = 6, height = 4)
schmidt_df%>%
  filter(Year %in% c(2021,2022))%>%
  mutate(Year = as.factor(Year))%>%
  ggplot(aes(x = Date_22, y = Schmidt, color = Year))+
  geom_point()+
  geom_line()+
  geom_vline(data=lines,aes(xintercept = Dates, lty = status), show.legend = F)+
  scale_linetype_manual(values = c("solid","dashed"))+
  ylab("Schmidt stability (J/m^2)")+
  theme_bw()+
  xlab("Date")
dev.off()

meta_depths = catwalk_format%>%
  group_by(Date,Depth_m)%>%
  summarize(Temp_C = mean(Temp_C))%>%
  group_by(Date)%>%
  summarize(epi_depth = meta.depths(Temp_C, Depth_m)[1],
            hypo_depth = meta.depths(Temp_C, Depth_m)[2])%>%
  pivot_longer(c(epi_depth,hypo_depth))

meta_depths$Date_22 = meta_depths$Date
year(meta_depths$Date_22)=2022

meta_depths%>%
  mutate(Year = as.factor(year(Date)))%>%
  filter(Year %in% c(2021,2022))%>%
  ggplot(aes(x = Date_22, y = value, color = Year))+
  geom_line()+
  facet_wrap(~name)
```

